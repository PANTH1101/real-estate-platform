{% extends 'base.html' %}
{% load static %}

{% block title %}Properties - Real Estate Hub{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-3 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Filters</h5>
            </div>
            <div class="card-body">
                <form id="filterForm">
                    <div class="mb-3">
                        <label class="form-label">City</label>
                        <input type="text" class="form-control" id="city" name="city" placeholder="e.g., Ahmedabad">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Locality</label>
                        <input type="text" class="form-control" id="locality" name="locality">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Property Type</label>
                        <select class="form-select" id="property_type" name="property_type">
                            <option value="">All</option>
                            <option value="HOUSE">House</option>
                            <option value="FLAT">Flat</option>
                            <option value="LAND">Land</option>
                            <option value="COMMERCIAL">Commercial</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Listing Type</label>
                        <select class="form-select" id="listing_type" name="listing_type">
                            <option value="">All</option>
                            <option value="SALE">For Sale</option>
                            <option value="RENT">For Rent</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Min Price (₹)</label>
                        <input type="number" class="form-control" id="price_min" name="price_min" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Max Price (₹)</label>
                        <input type="number" class="form-control" id="price_max" name="price_max" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bedrooms</label>
                        <input type="number" class="form-control" id="bedrooms" name="bedrooms" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bathrooms</label>
                        <input type="number" class="form-control" id="bathrooms" name="bathrooms" min="0">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
                    <button type="button" class="btn btn-outline-secondary w-100 mt-2" onclick="resetFilters()">Reset</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-9">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Properties</h2>
            <div id="loadingSpinner" class="spinner-border text-primary d-none" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="propertiesContainer" class="row g-4">
            <!-- Properties will be loaded here -->
        </div>
        <div id="noResults" class="text-center py-5 d-none">
            <p class="text-muted">No properties found. Try adjusting your filters.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/api.js' %}"></script>
<script>
let currentUser = null;

async function loadProperties() {
    const container = document.getElementById('propertiesContainer');
    const spinner = document.getElementById('loadingSpinner');
    const noResults = document.getElementById('noResults');
    
    spinner.classList.remove('d-none');
    container.innerHTML = '';
    noResults.classList.add('d-none');
    
    try {
        const form = document.getElementById('filterForm');
        const formData = new FormData(form);
        const params = {};
        for (const [key, value] of formData.entries()) {
            if (value) params[key] = value;
        }
        
        const data = await propertyAPI.search(params);
        spinner.classList.add('d-none');
        
        if (data.results && data.results.length > 0) {
            container.innerHTML = data.results.map(prop => renderPropertyCard(prop)).join('');
        } else {
            noResults.classList.remove('d-none');
        }
    } catch (error) {
        spinner.classList.add('d-none');
        showAlert('Failed to load properties. ' + error.message, 'danger');
    }
}

function renderPropertyCard(prop) {
    const imageUrl = prop.media && prop.media.length > 0 
        ? prop.media[0].file 
        : '/static/images/placeholder.jpg';
    const price = formatCurrency(prop.price);
    const statusBadge = prop.status === 'SOLD' 
        ? '<span class="badge bg-danger">Sold</span>' 
        : '<span class="badge bg-success">Available</span>';
    
    return `
        <div class="col-md-6 col-lg-4">
            <div class="card property-card h-100">
                <div class="property-image-wrapper">
                    <img src="${imageUrl}" class="card-img-top" alt="${prop.title}" style="height: 200px; object-fit: cover;">
                    ${statusBadge}
                </div>
                <div class="card-body">
                    <h5 class="card-title">${prop.title}</h5>
                    <p class="text-muted small mb-2">${prop.city}, ${prop.locality}</p>
                    <p class="h5 text-primary mb-2">${price}</p>
                    <div class="d-flex gap-2 mb-2">
                        <small><i class="bi bi-house"></i> ${prop.bedrooms || 0} Beds</small>
                        <small><i class="bi bi-droplet"></i> ${prop.bathrooms || 0} Baths</small>
                        <small><i class="bi bi-rulers"></i> ${prop.area_sqft} sqft</small>
                    </div>
                    <a href="/properties/${prop.id}/" class="btn btn-sm btn-primary w-100">View Details</a>
                </div>
            </div>
        </div>
    `;
}

function resetFilters() {
    document.getElementById('filterForm').reset();
    loadProperties();
}

document.getElementById('filterForm').addEventListener('submit', (e) => {
    e.preventDefault();
    loadProperties();
});

// Load properties on page load
(async () => {
    currentUser = await checkAuth();
    loadProperties();
})();
</script>
{% endblock %}

